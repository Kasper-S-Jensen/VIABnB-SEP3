@page "/Messages"
@inject NavigationManager NavigationManager; 
@inject AuthenticationStateProvider AuthenticationStateProvider; 
@inject IUserService UserService
@using SEP3BlazorT1Client.Models
@using Microsoft.AspNetCore.SignalR.Client
@using SEP3BlazorT1Client.Data
@using System.Text.Json
@if (!_connectionFailed)
{
    @foreach (var message in _messages)
    {
        <p>@message.Content</p>
    }
}
else
{
    <p>Something went wrong, try again later...</p>
}

@code {
    private Queue<Message> _messages = new();
    private HubConnection _connection;
    private User _sender;
    private User _receiver;
    private IDictionary<string, User> _contactedUsers = new Dictionary<string, User>();
    private bool _connectionFailed = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await ConnectToServer();
        }
        catch (Exception e)
        {
            _connectionFailed = true;
        }
    }


    private async Task ConnectToServer()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _sender = await UserService.GetUserByEmailAsync(user.Identity.Name);
        _connection = new HubConnectionBuilder().WithUrl($"https://localhost:5001/chat?email={_sender.Email}").WithAutomaticReconnect().Build();
        _connection.On<string>("ReceiveMessage", ReceiveMessage);
        _connection.On<string>("ReceiveUserMessages", ReceiveUserMessages);
        await _connection.StartAsync();
        await _connection.InvokeAsync("GetMessages");
        _connectionFailed = false;
        PopulateContactedUsers();
        StateHasChanged();
    }

    private void ReceiveMessage(string messageAsJson)
    {
        var messageReceived = JsonSerializer.Deserialize<Message>(messageAsJson, new JsonSerializerOptions() {PropertyNamingPolicy = JsonNamingPolicy.CamelCase});
        _messages.Enqueue(messageReceived);
    }

    private void PopulateContactedUsers()
    {
        foreach (var message in _messages)
        {
            if (!_contactedUsers.ContainsKey(message.Receiver.Email))
            {
                _contactedUsers.TryAdd(message.Receiver.Email, message.Receiver);
            }
            if (!_contactedUsers.ContainsKey(message.Sender.Email))
            {
                _contactedUsers.TryAdd(message.Sender.Email, message.Sender);
            }
        }
    }


    private void ReceiveUserMessages(string messagesAsJson)
    {
        Console.WriteLine($"Received messages: {messagesAsJson}");
        var receivedMessages = JsonSerializer.Deserialize<Queue<Message>>(messagesAsJson, new JsonSerializerOptions() {PropertyNamingPolicy = JsonNamingPolicy.CamelCase});
        _messages = receivedMessages;
        StateHasChanged();
    }

}